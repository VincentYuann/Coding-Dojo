{% extends "base.html" %}

<!-- Add a class to the container to make the login box smaller -->
{% block container_class %}login-container{% endblock %} 

{% block head %}
    <title>Login & Register</title>
{% endblock %} 

{% block body %}
    <header>
        <h1>To-Do List</h1>
    </header>

    <!-- Flashed messages -->
    {% with messages = get_flashed_messages() %} 
        {% if messages %} 
            {% for message in messages %}
                <p class="flash-message flash-error">{{ message | safe }}</p>
            {% endfor %} 
        {% endif %} 
    {% endwith %}

    <!-- Form for logging in -->
    <form id="form">
        <div class="form-group">
            <label for="username">Username</label>
            <input
                type="text"
                name="username"
                id="username"
                class="form-control"
                placeholder="Enter username"
                value="{{ submitted_username }}"
                required
            />
        </div>

        <div class="form-group">
            <label for="password">Password</label>
            <div class="password-wrapper">
                <input
                    type="password"
                    name="password"
                    id="password"
                    class="form-control"
                    placeholder="Enter password"
                    required
                />
                <input type="checkbox" onclick="togglePassword()" title="Show password" />
            </div>
        </div>

        <!-- Button actions -->
        <div class="form-actions">
            <button
                id="btn_login"
                value="Login"
                onclick="setActionForm(this.value)"
                class="btn btn-primary"
                type="button"
            >
                Login
            </button>
            <button
                id="btn_register"
                value="Register"
                onclick="setActionForm(this.value)"
                class="btn btn-secondary"
                type="button"
            >
                Register
            </button>
        </div>
    </form>

    <hr>

    <!-- Saved users dropdown -->
    <div class="saved-users">
        <div class="form-group">
            <label for="saved_users">Saved users</label>
            <select name="saved_users" id="saved_users" class="form-control" onchange="fillBlanks(this)">
                <option selected disabled>-- Choose a saved login --</option>
                {% for user in users %}
                    <option value="{{ user.username }}">{{ user.username }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <script>
      function setActionForm(action) {
        let form = document.querySelector("#form");

        if (action.toLowerCase() == "register") {
          form.action = "{{ url_for('register') }}";
          form.method = "POST";
        } else if (action.toLowerCase() == "login") {
          form.action = "{{ url_for('login') }}";
          form.method = "POST";
        }
        // Only submit if validation passes
        if (form.checkValidity()) {
            form.submit();
        } else {
            // This will trigger the browser's built-in validation messages
            form.reportValidity();
        }
      }

      function togglePassword() {
        let passwordInput = document.querySelector("#password");
        if (passwordInput.type === "password") {
          passwordInput.type = "text";
        } else {
          passwordInput.type = "password";
        }
      }

      function fillBlanks(selectElement) {
        let selectedUser = selectElement.value;
        document.querySelector("#username").value = selectedUser;
        document.querySelector("#password").value = "";
        document.querySelector("#password").focus(); // Focus password field
      }
    </script>
{% endblock %}
